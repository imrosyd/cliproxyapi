<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIProxyAPI+ Control Center</title>
    <meta name="description" content="Professional management dashboard for CLIProxyAPI+ proxy server">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-0: #09090b;
            --bg-1: #0f0f12;
            --bg-2: #16161a;
            --bg-3: #1c1c22;
            --bg-4: #24242c;
            --bg-hover: #2a2a34;
            --border: rgba(255, 255, 255, .07);
            --border-hover: rgba(255, 255, 255, .13);
            --text-0: #fafafa;
            --text-1: #e4e4e7;
            --text-2: #a1a1aa;
            --text-3: #63637a;
            --accent: #8b5cf6;
            --accent-h: rgba(139, 92, 246, .15);
            --accent-glow: rgba(139, 92, 246, .25);
            --success: #34d399;
            --success-h: rgba(52, 211, 153, .12);
            --warn: #fbbf24;
            --warn-h: rgba(251, 191, 36, .12);
            --error: #f87171;
            --error-h: rgba(248, 113, 113, .12);
            --blue: #60a5fa;
            --blue-h: rgba(96, 165, 250, .12);
            --r: 10px;
            --r-sm: 6px;
            --r-lg: 14px;
            --t: 150ms ease;
            --font: 'Inter', system-ui, sans-serif;
            --mono: 'JetBrains Mono', monospace;
            --glass: rgba(255, 255, 255, .03);
            --glass-border: rgba(255, 255, 255, .06)
        }

        [data-theme="light"] {
            --bg-0: #fafafa;
            --bg-1: #f4f4f5;
            --bg-2: #e4e4e7;
            --bg-3: #d4d4d8;
            --bg-4: #c4c4cc;
            --bg-hover: #d8d8de;
            --border: rgba(0, 0, 0, .08);
            --border-hover: rgba(0, 0, 0, .15);
            --text-0: #09090b;
            --text-1: #18181b;
            --text-2: #52525b;
            --text-3: #a1a1aa;
            --accent: #7c3aed;
            --accent-h: rgba(124, 58, 237, .1);
            --accent-glow: rgba(124, 58, 237, .2);
            --success: #059669;
            --success-h: rgba(5, 150, 105, .1);
            --warn: #d97706;
            --warn-h: rgba(217, 119, 6, .1);
            --error: #dc2626;
            --error-h: rgba(220, 38, 38, .1);
            --blue: #2563eb;
            --blue-h: rgba(37, 99, 235, .1);
            --glass: rgba(0, 0, 0, .02);
            --glass-border: rgba(0, 0, 0, .06)
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: var(--font);
            background: var(--bg-0);
            color: var(--text-0);
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased
        }

        .bg-mesh {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at 20% 0%, rgba(139, 92, 246, .06), transparent 50%), radial-gradient(ellipse at 80% 100%, rgba(96, 165, 250, .04), transparent 50%);
            pointer-events: none;
            z-index: 0
        }

        .shell {
            position: relative;
            z-index: 1;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px 24px 40px
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border)
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--blue));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border)
        }

        .status-pill.running {
            background: var(--success-h);
            border-color: rgba(52, 211, 153, .3);
            color: var(--success)
        }

        .status-pill.stopped {
            background: var(--error-h);
            border-color: rgba(248, 113, 113, .2);
            color: var(--error)
        }

        .status-pill.starting {
            background: var(--warn-h);
            border-color: rgba(251, 191, 36, .2);
            color: var(--warn)
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: currentColor
        }

        .status-pill.running .status-dot {
            animation: pulse 2s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .4
            }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .icon-btn {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r-sm);
            padding: 7px 10px;
            cursor: pointer;
            color: var(--text-2);
            font-size: 13px;
            transition: all var(--t);
            display: flex;
            align-items: center;
            gap: 5px
        }

        .icon-btn:hover {
            border-color: var(--border-hover);
            color: var(--text-0);
            background: var(--bg-3)
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 3px;
            margin-bottom: 20px
        }

        .tab {
            flex: 1;
            padding: 8px 16px;
            text-align: center;
            border-radius: var(--r-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-2);
            transition: all var(--t);
            border: none;
            background: none
        }

        .tab:hover {
            color: var(--text-1);
            background: var(--bg-2)
        }

        .tab.active {
            background: var(--bg-3);
            color: var(--text-0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, .2)
        }

        .tab-content {
            display: none;
            animation: fadeIn .2s ease
        }

        .tab-content.active {
            display: block
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        /* Cards */
        .card {
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: var(--r-lg);
            padding: 20px;
            margin-bottom: 16px;
            transition: border-color var(--t)
        }

        .card:hover {
            border-color: var(--border-hover)
        }

        .card-glass {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border)
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-0)
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-3)
        }

        /* Metric grid */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px
        }

        .metric {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 14px 16px;
            transition: all var(--t)
        }

        .metric:hover {
            border-color: var(--border-hover);
            transform: translateY(-1px)
        }

        .metric-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 4px
        }

        .metric-value {
            font-size: 22px;
            font-weight: 700;
            font-family: var(--mono)
        }

        .metric-sub {
            font-size: 11px;
            color: var(--text-3);
            margin-top: 2px
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--r-sm);
            border: 1px solid var(--border);
            background: var(--bg-2);
            color: var(--text-1);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--t);
            font-family: var(--font)
        }

        .btn:hover {
            border-color: var(--border-hover);
            background: var(--bg-3)
        }

        .btn:disabled {
            opacity: .4;
            cursor: not-allowed
        }

        .btn-accent {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff
        }

        .btn-accent:hover {
            filter: brightness(1.15);
            border-color: var(--accent)
        }

        .btn-success {
            background: var(--success-h);
            border-color: rgba(52, 211, 153, .3);
            color: var(--success)
        }

        .btn-danger {
            background: var(--error-h);
            border-color: rgba(248, 113, 113, .2);
            color: var(--error)
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px
        }

        /* Providers */
        .providers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px
        }

        .provider {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 12px;
            border-radius: var(--r);
            border: 1px solid var(--border);
            background: var(--bg-2);
            cursor: pointer;
            transition: all var(--t);
            position: relative
        }

        .provider:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15)
        }

        .provider.connected::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success)
        }

        .provider-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: .7
        }

        .provider-icon svg {
            width: 28px;
            height: 28px;
            fill: currentColor
        }

        .provider-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-2)
        }

        /* Usage section */
        .usage-provider {
            margin-bottom: 16px
        }

        .usage-provider-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r) var(--r) 0 0;
            cursor: pointer
        }

        .usage-provider-header.collapsed+.usage-models {
            display: none
        }

        .usage-provider-name {
            font-weight: 600;
            font-size: 13px;
            flex: 1
        }

        .usage-provider-count {
            font-size: 12px;
            color: var(--text-3);
            font-family: var(--mono)
        }

        .usage-models {
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--r) var(--r);
            overflow: hidden
        }

        .usage-model {
            display: grid;
            grid-template-columns: 1fr 100px 80px 120px;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            transition: background var(--t)
        }

        .usage-model:last-child {
            border-bottom: none
        }

        .usage-model:hover {
            background: var(--bg-hover)
        }

        .usage-model-name {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--text-1);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .usage-bar-wrap {
            height: 6px;
            background: var(--bg-4);
            border-radius: 3px;
            overflow: hidden
        }

        .usage-bar {
            height: 100%;
            border-radius: 3px;
            transition: width .5s ease;
            min-width: 2px
        }

        .usage-tokens {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--text-2);
            text-align: right
        }

        .usage-chart {
            padding: 12px 14px;
            border-top: 1px solid var(--border);
            background: var(--bg-0)
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 80px;
            padding: 0 4px
        }

        .chart-bar-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 0
        }

        .chart-bar {
            width: 100%;
            min-height: 2px;
            border-radius: 3px 3px 0 0;
            transition: height .5s ease;
            position: relative
        }

        .chart-bar:hover {
            filter: brightness(1.3)
        }

        .chart-bar-label {
            font-size: 9px;
            color: var(--text-3);
            font-family: var(--mono);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-align: center
        }

        .chart-title {
            font-size: 11px;
            color: var(--text-3);
            margin-bottom: 8px;
            font-weight: 500
        }

        .usage-reqs {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--text-2);
            text-align: center
        }

        /* Models list */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px
        }

        .model-chip {
            padding: 8px 12px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r-sm);
            font-family: var(--mono);
            font-size: 12px;
            color: var(--text-1);
            cursor: default;
            transition: all var(--t);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .model-chip:hover {
            border-color: var(--border-hover)
        }

        /* Config editor */
        .config-editor {
            width: 100%;
            min-height: 300px;
            background: var(--bg-0);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 14px;
            font-family: var(--mono);
            font-size: 13px;
            color: var(--text-1);
            resize: vertical;
            outline: none;
            line-height: 1.6
        }

        .config-editor:focus {
            border-color: var(--accent)
        }

        /* Activity log */
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-0);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 8px
        }

        .log-entry {
            display: flex;
            gap: 10px;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px
        }

        .log-entry:hover {
            background: var(--bg-2)
        }

        .log-time {
            color: var(--text-3);
            font-family: var(--mono);
            white-space: nowrap;
            min-width: 70px
        }

        .log-msg {
            color: var(--text-2)
        }

        .log-msg.success {
            color: var(--success)
        }

        .log-msg.error {
            color: var(--error)
        }

        .log-msg.warning {
            color: var(--warn)
        }

        /* Model manager */
        .mm-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        .mm-panel {
            background: var(--bg-0);
            border: 1px solid var(--border);
            border-radius: var(--r);
            overflow: hidden
        }

        .mm-panel-header {
            padding: 12px 14px;
            background: var(--bg-2);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .mm-panel-title {
            font-size: 13px;
            font-weight: 600
        }

        .mm-panel-count {
            font-size: 12px;
            color: var(--text-3);
            font-family: var(--mono)
        }

        .mm-search {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-bottom: 1px solid var(--border);
            background: var(--bg-1);
            color: var(--text-1);
            font-size: 13px;
            outline: none;
            font-family: var(--font)
        }

        .mm-list {
            max-height: 280px;
            overflow-y: auto;
            padding: 4px
        }

        .mm-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--mono);
            font-size: 12px;
            color: var(--text-1);
            transition: background var(--t)
        }

        .mm-item:hover {
            background: var(--bg-2)
        }

        .mm-item.selected {
            background: var(--accent-h);
            color: var(--accent)
        }

        .mm-item.in-factory {
            opacity: .5
        }

        .mm-check {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid var(--border);
            flex-shrink: 0
        }

        .mm-item.selected .mm-check {
            background: var(--accent);
            border-color: var(--accent)
        }

        .mm-actions {
            padding: 10px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px
        }

        /* Collapsible */
        .collapse-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r);
            transition: all var(--t);
            margin-bottom: 0
        }

        .collapse-toggle:hover {
            border-color: var(--border-hover)
        }

        .collapse-toggle .arrow {
            transition: transform .2s ease;
            color: var(--text-3)
        }

        .collapse-toggle.open .arrow {
            transform: rotate(180deg)
        }

        .collapse-toggle.open {
            border-radius: var(--r) var(--r) 0 0;
            margin-bottom: 0
        }

        .collapse-body {
            display: none;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--r) var(--r);
            padding: 16px;
            background: var(--bg-1)
        }

        .collapse-body.open {
            display: block
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.show {
            display: flex
        }

        .modal {
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: var(--r-lg);
            width: 90%;
            max-width: 500px;
            overflow: hidden
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .modal-title {
            font-weight: 600
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-2);
            font-size: 20px;
            cursor: pointer
        }

        .modal-body {
            padding: 20px
        }

        .modal-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 10px 20px;
            font-size: 13px;
            z-index: 200;
            transition: transform .3s ease;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .toast.show {
            transform: translateX(-50%) translateY(0)
        }

        /* Checkbox */
        .check-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer
        }

        .check-row input {
            accent-color: var(--accent)
        }

        /* Responsive */
        @media(max-width:700px) {
            .shell {
                padding: 12px 14px 30px
            }

            .mm-panels {
                grid-template-columns: 1fr
            }

            .metrics {
                grid-template-columns: repeat(2, 1fr)
            }

            .usage-model {
                grid-template-columns: 1fr 60px
            }

            .usage-tokens,
            .usage-bar-wrap {
                display: none
            }

            .tabs {
                overflow-x: auto
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px
        }

        ::-webkit-scrollbar-track {
            background: transparent
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-4);
            border-radius: 3px
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-3)
        }

        /* Animate in */
        .ani {
            opacity: 0;
            transform: translateY(8px);
            animation: fadeIn .35s ease forwards
        }

        .ani-1 {
            animation-delay: .05s
        }

        .ani-2 {
            animation-delay: .1s
        }

        .ani-3 {
            animation-delay: .15s
        }

        .ani-4 {
            animation-delay: .2s
        }

        /* Traffic Inspector */
        .log-entry-row {
            transition: background var(--t);
        }

        .log-entry-row:hover {
            background: var(--bg-hover);
        }

        .log-entry-row td {
            padding: 4px 10px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        /* Provider ping */
        .provider-ping {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            font-family: var(--mono);
            opacity: 0;
            transition: opacity var(--t);
        }

        .provider.connected .provider-ping {
            opacity: 1;
        }

        .ping-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .ping-good {
            background: var(--success);
        }

        .ping-warn {
            background: var(--warn);
        }

        .ping-err {
            background: var(--error);
        }

        /* Playground */
        .pg-msg {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: var(--r);
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .pg-msg.user {
            align-self: flex-end;
            background: var(--accent-h);
            border: 1px solid rgba(139, 92, 246, .2);
            color: var(--text-0);
        }

        .pg-msg.bot {
            align-self: flex-start;
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--text-1);
        }

        /* Routing rules */
        .route-rule {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .route-rule select {
            flex: 1;
            min-width: 100px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-1);
            color: var(--text-1);
            outline: none;
        }
    </style>
</head>

<body>
    <div class="bg-mesh"></div>
    <div class="shell">
        <!-- HEADER -->
        <header class="header ani">
            <div class="header-left">
                <span class="logo">CLIProxyAPI+</span>
                <div class="status-pill stopped" id="statusPill">
                    <span class="status-dot"></span>
                    <span id="statusLabel">Stopped</span>
                </div>
            </div>
            <div class="header-right">
                <label class="check-row" title="Auto-start server on launch">
                    <input type="checkbox" id="autoStartCheck" onchange="toggleAutoStart()">
                    <span>Auto-start</span>
                </label>
                <button class="icon-btn" onclick="checkForUpdate()" title="Check updates"><svg width="16" height="16"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg></button>
                <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="Toggle theme"><svg id="themeIcon"
                        width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg></button>
            </div>
        </header>

        <!-- TABS -->
        <div class="tabs ani ani-1">
            <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('providers')">Providers</button>
            <button class="tab" onclick="switchTab('models')">Models</button>
            <button class="tab" onclick="switchTab('routing')">Routing</button>
            <button class="tab" onclick="switchTab('playground')">Playground</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- TAB: DASHBOARD -->
        <div class="tab-content active" id="tab-dashboard">
            <!-- Controls -->
            <div class="card ani ani-2">
                <div class="card-header">
                    <span class="card-title">Server Controls</span>
                    <span class="card-subtitle" id="endpointLabel">http://localhost:8317/v1</span>
                </div>
                <div class="controls">
                    <button class="btn btn-accent" id="btnStart" onclick="startServer()">â–¶ Start</button>
                    <button class="btn btn-danger" id="btnStop" onclick="stopServer()" disabled>â–  Stop</button>
                    <button class="btn" id="btnRestart" onclick="restartServer()" disabled>â†» Restart</button>
                </div>
                <div style="display:flex;gap:16px;margin-top:12px;font-size:12px;color:var(--text-3)">
                    <span>PID: <span id="pidVal" style="font-family:var(--mono)">â€”</span></span>
                    <span>Uptime: <span id="uptimeVal" style="font-family:var(--mono)">â€”</span></span>
                </div>
            </div>

            <!-- Stats -->
            <div class="metrics ani ani-3">
                <div class="metric">
                    <div class="metric-label">Total Requests</div>
                    <div class="metric-value" id="statTotal">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Success Rate</div>
                    <div class="metric-value" id="statSuccess">0%</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Avg Latency</div>
                    <div class="metric-value" id="statLatency">0ms</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Est. Cost</div>
                    <div class="metric-value" id="statCost">$0.00</div>
                </div>
                <div class="metric">
                    <div class="metric-label">CPU / RAM</div>
                    <div class="metric-value" id="statCPU">0%</div>
                    <div class="metric-sub" id="statRAM">0MB</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total Tokens</div>
                    <div class="metric-value" id="statTokens">â€”</div>
                    <div class="metric-sub" id="statTokensSub">Enable usage stats</div>
                </div>
            </div>

            <!-- Usage by Provider -->
            <div class="card ani ani-4">
                <div class="card-header">
                    <span class="card-title">Usage by Provider</span>
                    <button class="btn btn-sm" onclick="refreshUsage()">â†» Refresh</button>
                </div>
                <div id="usageContainer">
                    <div style="text-align:center;padding:30px;color:var(--text-3);font-size:13px">
                        Start server and enable <code
                            style="font-family:var(--mono);background:var(--bg-3);padding:2px 6px;border-radius:4px">usage-statistics-enabled: true</code>
                        in config to see usage data
                    </div>
                </div>
            </div>

            <!-- Activity / Traffic Inspector -->
            <div class="card ani ani-4">
                <div class="card-header">
                    <span class="card-title">Traffic Inspector</span>
                    <div style="display:flex;gap:6px">
                        <button class="btn btn-sm" onclick="clearLogs()">Clear</button>
                        <button class="btn btn-sm" onclick="refreshStatus()">Refresh</button>
                    </div>
                </div>
                <div class="log-container" style="padding:0;overflow:auto;">
                    <table class="inspector-table"
                        style="width:100%;border-collapse:collapse;font-size:12px;font-family:var(--mono);text-align:left;">
                        <thead
                            style="background:var(--bg-2);border-bottom:1px solid var(--border);position:sticky;top:0;">
                            <tr>
                                <th style="padding:6px 10px;font-weight:500;color:var(--text-2)">Time</th>
                                <th style="padding:6px 10px;font-weight:500;color:var(--text-2)">Source</th>
                                <th style="padding:6px 10px;font-weight:500;color:var(--text-2)">Model</th>
                                <th style="padding:6px 10px;font-weight:500;color:var(--text-2)">Lat.</th>
                                <th style="padding:6px 10px;font-weight:500;color:var(--text-2);width:100%">Message</th>
                            </tr>
                        </thead>
                        <tbody id="logContainer">
                            <tr class="log-entry-row">
                                <td colspan="5" style="padding:8px 10px;text-align:center;color:var(--text-3)">
                                    Initializing...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: PROVIDERS -->
        <div class="tab-content" id="tab-providers">
            <div class="card ani">
                <div class="card-header">
                    <span class="card-title">Authentication Providers</span>
                    <span class="card-subtitle">Click to login</span>
                </div>
                <div class="providers-grid" id="providersGrid">
                    <div class="provider" id="provider-gemini" onclick="loginProvider('gemini')">
                        <div class="provider-icon"><svg viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M14 28C14 26.0633 13.6267 24.2433 12.88 22.54C12.1567 20.8367 11.165 19.355 9.905 18.095C8.645 16.835 7.16333 15.8433 5.46 15.12C3.75667 14.3733 1.93667 14 0 14C1.93667 14 3.75667 13.6383 5.46 12.915C7.16333 12.1683 8.645 11.165 9.905 9.905C11.165 8.645 12.1567 7.16333 12.88 5.46C13.6267 3.75667 14 1.93667 14 0C14 1.93667 14.3617 3.75667 15.085 5.46C15.8317 7.16333 16.835 8.645 18.095 9.905C19.355 11.165 20.8367 12.1683 22.54 12.915C24.2433 13.6383 26.0633 14 28 14C26.0633 14 24.2433 14.3733 22.54 15.12C20.8367 15.8433 19.355 16.835 18.095 18.095C16.835 19.355 15.8317 20.8367 15.085 22.54C14.3617 24.2433 14 26.0633 14 28Z"
                                    fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">Gemini</div>
                    </div>
                    <div class="provider" id="provider-copilot" onclick="loginProvider('copilot')">
                        <div class="provider-icon"><svg viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M600 0C268.6 0 0 268.6 0 600C0 865.2 171.8 1090.4 412.6 1175.4C442.6 1181 453.8 1162.4 453.8 1146.6C453.8 1132.4 453.2 1084.4 452.8 1036.4C285 1072 249.6 960 249.6 960C222.4 890.8 183.2 872.4 183.2 872.4C129.4 836 187.4 836.8 187.4 836.8C247.2 841 278.6 898.4 278.6 898.4C332.2 989.2 419.6 963.2 455.4 947.6C460.8 908.4 476.8 881.6 494.2 866.4C360 850.8 219 799.2 219 569.2C219 503.6 243.2 449.8 280 407.6C274 392 253.4 330.8 285.6 248.4C285.6 248.4 336.4 231.6 452 309.2C500 296.8 551.2 290.6 602 290.4C652.8 290.6 704 296.8 752 309.2C867.4 231.6 918.2 248.4 918.2 248.4C950.4 330.8 929.8 392 923.8 407.6C960.8 449.8 984.8 503.6 984.8 569.2C984.8 799.6 843.6 850.6 709 866C730.8 884.8 750.2 921.6 750.2 977.6C750.2 1058.4 749.4 1124 749.4 1146.4C749.4 1162.4 760.4 1181.2 790.8 1175.2C1031.2 1090 1200 865.2 1200 600C1200 268.6 931.4 0 600 0Z"
                                    fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">Copilot</div>
                    </div>
                    <div class="provider" id="provider-antigravity" onclick="loginProvider('antigravity')">
                        <div class="provider-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="m19.94,20.59c1.09.82,2.73.27,1.23-1.23-4.5-4.36-3.55-16.36-9.14-16.36S7.39,15,2.89,19.36c-1.64,1.64.14,2.05,1.23,1.23,4.23-2.86,3.95-7.91,7.91-7.91s3.68,5.05,7.91,7.91Z" fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">Antigravity</div>
                    </div>
                    <div class="provider" id="provider-codex" onclick="loginProvider('codex')">
                        <div class="provider-icon"><svg viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="m297.06 130.97c7.26-21.79 4.76-45.66-6.85-65.48-17.46-30.4-52.56-46.04-86.84-38.68-15.25-17.18-37.16-26.95-60.13-26.81-35.04-.08-66.13 22.48-76.91 55.82-22.51 4.61-41.94 18.7-53.31 38.67-17.59 30.32-13.58 68.54 9.92 94.54-7.26 21.79-4.76 45.66 6.85 65.48 17.46 30.4 52.56 46.04 86.84 38.68 15.24 17.18 37.16 26.95 60.13 26.8 35.06.09 66.16-22.49 76.94-55.86 22.51-4.61 41.94-18.7 53.31-38.67 17.57-30.32 13.55-68.51-9.94-94.51zm-120.28 168.11c-14.03.02-27.62-4.89-38.39-13.88.49-.26 1.34-.73 1.89-1.07l63.72-36.8c3.26-1.85 5.26-5.32 5.24-9.07v-89.83l26.93 15.55c.29.14.48.42.52.74v74.39c-.04 33.08-26.83 59.9-59.91 59.97zm-128.84-55.03c-7.03-12.14-9.56-26.37-7.15-40.18.47.28 1.3.79 1.89 1.13l63.72 36.8c3.23 1.89 7.23 1.89 10.47 0l77.79-44.92v31.1c.02.32-.13.63-.38.83l-64.41 37.19c-28.69 16.52-65.33 6.7-81.92-21.95zm-16.77-139.09c7-12.16 18.05-21.46 31.21-26.29 0 .55-.03 1.52-.03 2.2v73.61c-.02 3.74 1.98 7.21 5.23 9.06l77.79 44.91-26.93 15.55c-.27.18-.61.21-.91.08l-64.42-37.22c-28.63-16.58-38.45-53.21-21.95-81.89zm221.26 51.49-77.79-44.92 26.93-15.54c.27-.18.61-.21.91-.08l64.42 37.19c28.68 16.57 38.51 53.26 21.94 81.94-7.01 12.14-18.05 21.44-31.2 26.28v-75.81c.03-3.74-1.96-7.2-5.2-9.06zm26.8-40.34c-.47-.29-1.3-.79-1.89-1.13l-63.72-36.8c-3.23-1.89-7.23-1.89-10.47 0l-77.79 44.92v-31.1c-.02-.32.13-.63.38-.83l64.41-37.16c28.69-16.55 65.37-6.7 81.91 22 6.99 12.12 9.52 26.31 7.15 40.1zm-168.51 55.43-26.94-15.55c-.29-.14-.48-.42-.52-.74v-74.39c.02-33.12 26.89-59.96 60.01-59.94 14.01 0 27.57 4.92 38.34 13.88-.49.26-1.33.73-1.89 1.07l-63.72 36.8c-3.26 1.85-5.26 5.31-5.24 9.06l-.04 89.79zm14.63-31.54 34.65-20.01 34.65 20v40.01l-34.65 20-34.65-20z"
                                    fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">Codex</div>
                    </div>
                    <div class="provider" id="provider-claude" onclick="loginProvider('claude')">
                        <div class="provider-icon"><svg viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M234 800l235-132 4-11-4-7h-11l-40-2-134-4-116-5-113-6-28-6-27-35 3-18 27-16 34 3 75 5 124 91 18 15 7-5 1-4-9-14-67-122-72-124-32-50-8-30c-3-13-5-24-5-37l37-50 21-7 49 7 21 19 31 70 50 111 77 151 23 45 12 41 5 12h8v-7l6-85 12-104 11-134 4-38 19-45 37-24 29 14 24 38-3 22-14 92-28 144-18 97h11l12-12 49-65 82-103 36-43 42-45 27-21h51l38 56-17 58-53 67-44 56-63 85-39 67 4 6 9-1 142-30 77-14 92-15 41 19 5 20-17 40-98 24-115 23-171 40-2 2 3 4 77 7 33 2h80l150 11 40 26 24 32-5 24-60 31-82-20-191-45-65-16h-9v7l54 53 99 90 125 116 7 29-17 22-17-3-110-82-43-38-97-78h-8v9l22 32 116 175 6 54-8 17-30 11-33-6-68-94-71-107-52-94-6 4-57 361-16 18-33 14-30-23-16-37 16-67 19-97 15-75 14-95 8-31v-3l-7 1-71 98-108 147-86 92-20 8-36-18 3-33 20-27 119-149 72-93 46-54v-8h-3l-315 205-56 7-24-22 3-33 12-13 95-65z"
                                    fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">Claude</div>
                    </div>
                    <div class="provider" id="provider-qwen" onclick="loginProvider('qwen')">
                        <div class="provider-icon"><svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M191.4,122.7c.6,0,.7.3.4.7l-10.1,17.7-31.5,55.4c0,.3-.3.3-.6.3s-.4,0-.6-.3l-41.7-72.7c-.3-.4,0-.6.3-.6h2.7l81.2-.3h-.1ZM115.5,25.9c-.3,0-.4,0-.6.3l-34.6,60.6c-.3.6-.9.9-1.6.9h-34.6c-.7,0-.9.3-.4.9l70.1,122.6c.3.4.1.7-.4.7h-33.7c-1,0-1.9.6-2.4,1.6l-15.9,27.9c-.6,1,0,1.5.9,1.5h69c.6,0,1,.3,1.2.9l16.9,29.7c.6,1,1,1,1.6,0l60.4-105.7,9.5-16.6c0-.3.3-.3.6-.3s.4,0,.6.3l17.2,30.6c.3.4.7.7,1.3.7l33.4-.3c.1,0,.3,0,.4-.3v-.4l-35-61.5c-.3-.4-.3-.9,0-1.3l3.6-6.1,13.5-23.9c.3-.4,0-.7-.4-.7H116.1c-.7,0-.9-.3-.4-.9l17.4-30.3c.3-.4.3-.9,0-1.3l-16.5-28.9c0-.3-.3-.4-.6-.4h-.4ZM156.9,21.2c4.8,8.3,9.5,16.6,14.1,25.1.4.7,1,1,1.9,1h67c2.1,0,3.9,1.3,5.3,4l17.5,31c2.2,4,3,5.8.3,10.1-3.1,5.2-6.2,10.4-9.2,15.7l-4.5,8c-1.3,2.4-2.7,3.4-.4,6.2l32.1,56c2.1,3.6,1.3,5.9-.4,9.4-5.3,9.5-10.7,18.9-16.2,28.2-1.9,3.3-4.3,4.5-8.2,4.5-9.4-.1-18.7,0-28.1.1-.4,0-.7.3-1,.6-10.8,19.2-21.7,38.2-32.7,57.2-2.1,3.6-4.6,4.5-8.8,4.5h-36.4c-2.5,0-4.3-1-5.6-3.3l-16.2-28.1c-.1-.4-.6-.6-1-.6h-61.8c-3.4.3-6.7,0-9.6-1l-19.3-33.4c-1.2-1.9-1.2-4.3,0-6.5l14.5-25.5c.4-.7.4-1.6,0-2.4-7.6-13.2-15.1-26.3-22.6-39.5l-9.5-16.8c-1.9-3.7-2.1-5.9,1.2-11.6,5.6-9.8,11.1-19.6,16.8-29.4,1.6-2.8,3.7-4,7-4h31.3c.6,0,1-.3,1.3-.7l33.8-59.1c1.2-1.9,2.8-3,5-3h19.2l12.3-.3c4.2,0,8.8.4,10.8,4.2v-.6Z"
                                    fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">Qwen</div>
                    </div>
                    <div class="provider" id="provider-iflow" onclick="loginProvider('iflow')">
                        <div class="provider-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13 3v6h8V3h-8zM3 21h8v-6H3v6zm0-8h8V3H3v10zm10 8h8v-10h-8v10z"
                                    fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">iFlow</div>
                    </div>
                    <div class="provider" id="provider-kiro" onclick="loginProvider('kiro')">
                        <div class="provider-icon"><svg viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M398.554 818.914C316.315 1001.03 491.477 1046.74 620.672 940.156C658.687 1059.66 801.052 970.473 852.234 877.795C964.787 673.567 919.318 465.357 907.64 422.374C827.637 129.443 427.623 128.946 358.8 423.865C342.651 475.544 342.402 534.18 333.458 595.051C328.986 625.86 325.507 645.488 313.83 677.785C306.873 696.424 297.68 712.819 282.773 740.645C259.915 783.881 269.604 867.113 387.87 823.883L399.051 818.914H398.554Z"
                                    fill="currentColor" />
                                <ellipse cx="636" cy="487" rx="40" ry="63" fill="currentColor" />
                                <ellipse cx="771" cy="487" rx="40" ry="63" fill="currentColor" />
                            </svg></div>
                        <div class="provider-name">Kiro</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: MODELS -->
        <div class="tab-content" id="tab-models">
            <div class="card ani" id="modelsListCard">
                <div class="card-header">
                    <span class="card-title">Available Models</span>
                    <span class="card-subtitle" id="modelsCount">0 models</span>
                </div>
                <div class="models-grid" id="modelsGrid">
                    <div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-3)">Start server to see
                        models</div>
                </div>
            </div>
            <!-- Custom Model -->
            <div class="collapse-toggle" onclick="toggleCollapse('mmBody',this)">
                <div style="display:flex;align-items:center;gap:8px"><span>ðŸ”§</span><span
                        style="font-weight:600;font-size:14px">Custom Model</span></div>
                <span class="arrow">â–¼</span>
            </div>
            <div class="collapse-body" id="mmBody">
                <div class="mm-panels">
                    <div class="mm-panel">
                        <div class="mm-panel-header"><span class="mm-panel-title">Available from CLIProxyAPI</span><span
                                class="mm-panel-count" id="mmAvailCount">0</span></div>
                        <input class="mm-search" id="mmAvailSearch" placeholder="Filter..." oninput="filterMM('avail')">
                        <div class="mm-list" id="mmAvailList">
                            <div style="padding:16px;text-align:center;color:var(--text-3);font-size:12px">Start server
                                first</div>
                        </div>
                        <div class="mm-actions">
                            <button class="btn btn-success btn-sm" onclick="mmAddSelected()" id="mmBtnAdd" disabled>+
                                Add Selected</button>
                            <button class="btn btn-success btn-sm" onclick="mmAddAllMissing()" id="mmBtnAddAll"
                                disabled>+ Add All</button>
                        </div>
                    </div>
                    <div class="mm-panel">
                        <div class="mm-panel-header"><span class="mm-panel-title">Custom Model Config</span><span
                                class="mm-panel-count" id="mmFactoryCount">0</span></div>
                        <input class="mm-search" id="mmFactorySearch" placeholder="Filter..."
                            oninput="filterMM('factory')">
                        <div class="mm-list" id="mmFactoryList">
                            <div style="padding:16px;text-align:center;color:var(--text-3);font-size:12px">No models
                            </div>
                        </div>
                        <div class="mm-actions">
                            <button class="btn btn-danger btn-sm" onclick="mmRemoveSelected()" id="mmBtnRemove"
                                disabled>Remove Selected</button>
                            <button class="btn btn-danger btn-sm"
                                onclick="confirmAction('Clear all factory models?','This cannot be undone.',mmClearAll)">Clear
                                All</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: ROUTING -->
        <div class="tab-content" id="tab-routing">
            <div class="card ani">
                <div class="card-header">
                    <span class="card-title">Routing & Fallbacks</span>
                    <button class="btn btn-accent btn-sm" onclick="addRouteRule()">+ Add Rule</button>
                </div>
                <div id="routingList" style="display:flex;flex-direction:column;gap:12px">
                    <div style="text-align:center;padding:20px;color:var(--text-3);font-size:13px">No routing rules
                        configured. Create one to handle model fallbacks automatically.</div>
                </div>
                <div style="display:flex;justify-content:flex-end;margin-top:16px"><button class="btn btn-accent"
                        onclick="saveRoutes()" disabled id="btnSaveRoutes">Save Rules</button></div>
            </div>
        </div>

        <!-- TAB: PLAYGROUND -->
        <div class="tab-content" id="tab-playground">
            <div class="card ani" style="display:flex;flex-direction:column;height:550px;padding:0;overflow:hidden">
                <div class="card-header"
                    style="padding:16px 20px;border-bottom:1px solid var(--border);margin-bottom:0">
                    <span class="card-title">API Playground</span>
                    <select id="pgModel" class="btn" style="padding:6px 12px;font-size:13px">
                        <option value="">Loading models...</option>
                    </select>
                </div>
                <div id="pgChat"
                    style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;background:var(--bg-0)">
                    <div style="text-align:center;color:var(--text-3);font-size:13px;margin:auto">Send a message to test
                        the selected model<br>This uses your CLIProxyAPI+ endpoint</div>
                </div>
                <div style="padding:16px 20px;border-top:1px solid var(--border);background:var(--bg-1)">
                    <div style="display:flex;gap:10px">
                        <textarea id="pgInput" placeholder="Type a message... (Shift+Enter for new line)"
                            style="flex:1;background:var(--bg-0);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px 14px;color:var(--text-1);font-family:var(--font);font-size:13px;resize:none;height:50px;outline:none"
                            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendPgMessage();}"></textarea>
                        <button class="btn btn-accent" onclick="sendPgMessage()" style="min-width:80px">Send</button>
                        <button class="btn" onclick="clearPg()">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: SETTINGS -->
        <div class="tab-content" id="tab-settings">
            <div class="card ani">
                <div class="card-header" style="align-items:flex-start">
                    <div>
                        <span class="card-title">Configuration (config.yaml)</span>
                        <div style="color:var(--text-3);font-size:12px;margin-top:4px">Settings are automatically loaded
                            from disk.</div>
                    </div>
                    <div style="display:flex;gap:6px">
                        <span class="card-subtitle" id="configStatus" style="margin-right:8px;line-height:28px"></span>
                        <button class="btn btn-sm" onclick="exportConfig()" title="Download config">ðŸ“¥ Export</button>
                        <button class="btn btn-sm" onclick="document.getElementById('importFile').click()"
                            title="Load config file">ðŸ“¤ Import</button>
                        <input type="file" id="importFile" style="display:none" accept=".yaml,.yml,.txt"
                            onchange="importConfig(event)">
                        <button class="btn btn-sm" onclick="backupConfig()" title="Create quick backup on server">ðŸ’¾
                            Backup</button>
                    </div>
                </div>
                <textarea class="config-editor" id="configEditor" spellcheck="false"
                    placeholder="Loading..."></textarea>
                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
                    <button class="btn" onclick="reloadConfig()">Reload</button>
                    <button class="btn btn-accent" onclick="saveConfig()">Save & Restart</button>
                </div>
            </div>
        </div>

        <footer style="text-align:center;padding:20px 0;font-size:12px;color:var(--text-3)">
            <a href="https://github.com/imrosyd/cliproxyapi" target="_blank"
                style="color:var(--text-2);text-decoration:none">GitHub</a>
            <span style="margin:0 8px">Â·</span>
            <a href="https://github.com/imrosyd/cliproxyapi" target="_blank"
                style="color:var(--text-2);text-decoration:none">Upstream</a>
            <span style="margin:0 8px">Â·</span>
            Press <kbd
                style="background:var(--bg-3);padding:2px 6px;border-radius:4px;border:1px solid var(--border)">R</kbd>
            to refresh
        </footer>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="updateModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Update Available</span><button class="modal-close"
                    onclick="closeModal('updateModal')">&times;</button></div>
            <div class="modal-body">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><span
                        id="updateCurVer">?</span><span>â†’</span><span style="color:var(--success);font-weight:600"
                        id="updateNewVer">?</span></div>
                <div id="updateNotes" style="max-height:200px;overflow-y:auto;font-size:13px;color:var(--text-2)">
                    Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('updateModal')">Later</button>
                <button class="btn btn-accent" id="btnApplyUpdate" onclick="applyUpdate()">Update Now</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Confirm</span><button class="modal-close"
                    onclick="closeModal('confirmModal')">&times;</button></div>
            <div class="modal-body">
                <p id="confirmMsg">Are you sure?</p>
                <p style="color:var(--warn);font-size:12px;margin-top:8px" id="confirmWarn"></p>
            </div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('confirmModal')">Cancel</button><button
                    class="btn btn-danger" id="btnConfirm">Confirm</button></div>
        </div>
    </div>
    <div class="toast" id="toast"><span id="toastMsg"></span></div>

    <!-- JAVASCRIPT -->
    <script>
        /* ===== STATE ===== */
        let serverRunning = false, serverStartTime = null, uptimeInterval = null;
        let autoStartEnabled = localStorage.getItem('autoStart') === 'true';
        let pendingConfirmAction = null;
        let mmAvailModels = [], mmFactoryModels = [], mmAvailSelected = new Set(), mmFactorySelected = new Set();

        /* ===== TABS ===== */
        function switchTab(name) {
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', t.textContent.toLowerCase().includes(name)));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + name));
            if (name === 'settings') loadConfig();
            if (name === 'models') { loadModels(); loadFactoryConfig(); }
            if (name === 'providers') checkAuthStatus();
        }

        /* ===== THEME ===== */
        function toggleTheme() {
            const t = document.documentElement.getAttribute('data-theme') === 'light' ? '' : 'light';
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
            updateThemeIcon(t);
        }
        function updateThemeIcon(t) {
            const icon = document.getElementById('themeIcon');
            if (!icon) return;
            icon.innerHTML = t === 'light'
                ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
                : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
        }
        (function initTheme() { const t = localStorage.getItem('theme') || ''; document.documentElement.setAttribute('data-theme', t); updateThemeIcon(t); })();

        /* ===== LOG / INSPECTOR ===== */
        function log(msg, type = 'info', source = 'System', model = '-', lat = '-') {
            const table = document.getElementById('logContainer');
            if (!table) return;
            if (table.innerHTML.includes('Initializing')) { table.innerHTML = ''; }
            const t = new Date().toLocaleTimeString('en-US', { hour12: false });
            let col = 'var(--text-2)';
            if (type === 'success') col = 'var(--success)';
            if (type === 'error') col = 'var(--error)';
            if (type === 'warning') col = 'var(--warn)';
            const tr = document.createElement('tr');
            tr.className = 'log-entry-row';
            tr.innerHTML = `<td style="color:var(--text-3)">${t}</td><td>${source}</td><td>${model}</td><td style="font-family:var(--mono)">${lat}${lat !== '-' ? 'ms' : ''}</td><td style="color:${col}" title="${msg.replace(/"/g, "&quot;")}">${msg}</td>`;
            table.appendChild(tr);
            if (table.parentElement) table.parentElement.scrollTop = table.parentElement.scrollHeight;
        }
        function clearLogs() { document.getElementById('logContainer').innerHTML = ''; log('Logs cleared'); }
        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toastMsg').textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

        /* ===== MODALS ===== */
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function confirmAction(msg, warn, fn) { document.getElementById('confirmMsg').textContent = msg; document.getElementById('confirmWarn').textContent = warn || ''; pendingConfirmAction = fn; document.getElementById('btnConfirm').onclick = () => { closeModal('confirmModal'); if (pendingConfirmAction) pendingConfirmAction(); }; document.getElementById('confirmModal').classList.add('show'); }

        /* ===== SERVER CONTROLS ===== */
        async function checkStatus() {
            try {
                const r = await fetch('/api/status', { signal: AbortSignal.timeout(3000) });
                if (!r.ok) return;
                const s = await r.json();
                serverRunning = s.running;
                const pill = document.getElementById('statusPill');
                pill.className = 'status-pill ' + (s.running ? 'running' : 'stopped');
                document.getElementById('statusLabel').textContent = s.running ? 'Running' : 'Stopped';
                document.getElementById('btnStart').disabled = s.running;
                document.getElementById('btnStop').disabled = !s.running;
                document.getElementById('btnRestart').disabled = !s.running;
                document.getElementById('pidVal').textContent = s.pid || 'â€”';
                if (s.running && s.endpoint) document.getElementById('endpointLabel').textContent = s.endpoint;
                if (s.running && !serverStartTime) { serverStartTime = new Date(); startUptime(); }
                if (!s.running) { serverStartTime = null; if (uptimeInterval) { clearInterval(uptimeInterval); uptimeInterval = null; } document.getElementById('uptimeVal').textContent = 'â€”'; }
                if (s.running) { loadStats(); loadManagementUsage(); }
            } catch (e) { /* offline */ }
        }

        function startUptime() {
            if (uptimeInterval) clearInterval(uptimeInterval);
            uptimeInterval = setInterval(() => {
                if (!serverStartTime) return;
                const d = Math.floor((Date.now() - serverStartTime.getTime()) / 1000);
                const h = Math.floor(d / 3600), m = Math.floor((d % 3600) / 60), s = d % 60;
                document.getElementById('uptimeVal').textContent = `${h}h ${m}m ${s}s`;
            }, 1000);
        }

        async function startServer() {
            log('Starting server...', 'warning');
            document.getElementById('statusPill').className = 'status-pill starting';
            document.getElementById('statusLabel').textContent = 'Starting...';
            try {
                const r = await fetch('/api/start', { method: 'POST' });
                const d = await r.json();
                if (d.success) { log('Server started', 'success'); showToast('Server started'); }
                else { log('Start failed: ' + (d.error || 'Unknown'), 'error'); showToast('Start failed'); }
            } catch (e) { log('Start error: ' + e.message, 'error'); }
            setTimeout(checkStatus, 1500);
        }
        async function stopServer() {
            log('Stopping server...', 'warning');
            try { await fetch('/api/stop', { method: 'POST' }); log('Server stopped', 'success'); showToast('Server stopped'); } catch (e) { log('Stop error', 'error'); }
            setTimeout(checkStatus, 1000);
        }
        async function restartServer() {
            log('Restarting...', 'warning');
            try { await fetch('/api/restart', { method: 'POST' }); log('Server restarted', 'success'); showToast('Restarted'); } catch (e) { log('Restart error', 'error'); }
            setTimeout(checkStatus, 2000);
        }

        /* ===== STATS ===== */
        async function loadStats() {
            try {
                const r = await fetch('/api/stats'); const d = await r.json();
                document.getElementById('statTotal').textContent = d.total || 0;
                document.getElementById('statSuccess').textContent = (d.successRate || 0) + '%';
                document.getElementById('statLatency').textContent = (d.avgLatency || 0) + 'ms';
            } catch (e) { }
        }

        /* ===== MANAGEMENT USAGE (upstream API) ===== */
        async function loadManagementUsage() {
            try {
                const r = await fetch('/api/management/usage');
                const d = await r.json();
                if (d.available === false) { renderUsageFallback(d.error); return; }
                const usage = d.usage || d;
                if (usage.total_requests !== undefined) {
                    document.getElementById('statTotal').textContent = usage.total_requests;
                    const rate = usage.total_requests > 0 ? Math.round(usage.success_count / usage.total_requests * 100) : 0;
                    document.getElementById('statSuccess').textContent = rate + '%';
                }
                if (usage.total_tokens !== undefined && usage.total_tokens > 0) {
                    document.getElementById('statTokens').textContent = formatTokens(usage.total_tokens);
                    document.getElementById('statTokensSub').textContent = 'from Management API';
                }
                renderUsageByProvider(usage);
            } catch (e) { renderUsageFallback('Management API unavailable'); }
        }
        function refreshUsage() { loadManagementUsage(); loadStats(); showToast('Usage refreshed'); }

        function formatTokens(n) {
            if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toString();
        }

        const PROVIDER_COLORS = { gemini: '#4285f4', copilot: '#6e40c9', antigravity: '#f97316', codex: '#10b981', claude: '#d97706', qwen: '#8b5cf6', iflow: '#06b6d4', kiro: '#ec4899', openai: '#10b981', unknown: '#6b7280' };

        function detectProvider(model) {
            const m = model.toLowerCase();
            if (m.includes('gemini') || m.includes('aistudio')) return 'gemini';
            if (m.includes('copilot') || m.includes('github')) return 'copilot';
            if (m.includes('claude') && m.includes('kiro')) return 'kiro';
            if (m.includes('claude')) return 'claude';
            if (m.includes('gpt') || m.includes('o1') || m.includes('o3') || m.includes('codex-mini')) return 'codex';
            if (m.includes('qwen') || m.includes('qwq')) return 'qwen';
            if (m.includes('antigravity')) return 'antigravity';
            if (m.includes('iflow')) return 'iflow';
            if (m.includes('kiro')) return 'kiro';
            return 'unknown';
        }

        function renderUsageByProvider(usage) {
            const c = document.getElementById('usageContainer');
            const apis = usage.apis || {};
            if (!Object.keys(apis).length) { renderUsageFallback('No usage data yet. Make some requests first.'); return; }
            // Group models by provider
            const byProvider = {};
            for (const [apiKey, apiData] of Object.entries(apis)) {
                const models = apiData.models || {};
                for (const [modelName, modelData] of Object.entries(models)) {
                    const prov = detectProvider(modelName);
                    if (!byProvider[prov]) byProvider[prov] = { totalReqs: 0, totalTokens: 0, models: {} };
                    byProvider[prov].models[modelName] = modelData;
                    byProvider[prov].totalReqs += modelData.total_requests || 0;
                    byProvider[prov].totalTokens += modelData.total_tokens || 0;
                }
            }
            const maxReqs = Math.max(...Object.values(byProvider).map(p => p.totalReqs), 1);
            let html = '';
            for (const [prov, data] of Object.entries(byProvider).sort((a, b) => b[1].totalReqs - a[1].totalReqs)) {
                const color = PROVIDER_COLORS[prov] || PROVIDER_COLORS.unknown;
                html += `<div class="usage-provider">
            <div class="usage-provider-header" onclick="this.classList.toggle('collapsed')">
                <div style="width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0"></div>
                <span class="usage-provider-name">${prov.charAt(0).toUpperCase() + prov.slice(1)}</span>
                <span class="usage-provider-count">${data.totalReqs} reqs Â· ${formatTokens(data.totalTokens)} tokens</span>
                <span class="arrow" style="font-size:10px;color:var(--text-3)">â–¼</span>
            </div>
            <div class="usage-models">`;
                const modelEntries = Object.entries(data.models).sort((a, b) => (b[1].total_requests || 0) - (a[1].total_requests || 0));
                const modelMax = Math.max(...modelEntries.map(([, m]) => m.total_requests || 0), 1);
                const tokenMax = Math.max(...modelEntries.map(([, m]) => m.total_tokens || 0), 1);
                // Model list rows
                for (const [mName, mData] of modelEntries) {
                    const pct = Math.round((mData.total_requests || 0) / modelMax * 100);
                    html += `<div class="usage-model">
                <span class="usage-model-name" title="${mName}">${mName}</span>
                <span class="usage-reqs">${mData.total_requests || 0}</span>
                <div class="usage-bar-wrap"><div class="usage-bar" style="width:${pct}%;background:${color}"></div></div>
                <span class="usage-tokens">${formatTokens(mData.total_tokens || 0)} tok</span>
            </div>`;
                }
                // Bar chart visualization
                if (modelEntries.length > 0) {
                    html += `<div class="usage-chart">
                    <div class="chart-title">Request Distribution</div>
                    <div class="chart-bars">`;
                    for (const [mName, mData] of modelEntries.slice(0, 12)) {
                        const h = Math.max(Math.round((mData.total_requests || 0) / modelMax * 70), 3);
                        const shortName = mName.split('/').pop().split('-').slice(0, 2).join('-');
                        html += `<div class="chart-bar-wrap" title="${mName}: ${mData.total_requests} reqs, ${formatTokens(mData.total_tokens || 0)} tokens">
                        <div class="chart-bar" style="height:${h}px;background:${color}"></div>
                        <span class="chart-bar-label">${shortName}</span>
                    </div>`;
                    }
                    html += `</div>
                    <div class="chart-title" style="margin-top:10px">Token Usage</div>
                    <div class="chart-bars">`;
                    for (const [mName, mData] of modelEntries.slice(0, 12)) {
                        const h = Math.max(Math.round((mData.total_tokens || 0) / tokenMax * 70), 3);
                        const shortName = mName.split('/').pop().split('-').slice(0, 2).join('-');
                        html += `<div class="chart-bar-wrap" title="${mName}: ${formatTokens(mData.total_tokens || 0)} tokens">
                        <div class="chart-bar" style="height:${h}px;background:${color};opacity:.7"></div>
                        <span class="chart-bar-label">${shortName}</span>
                    </div>`;
                    }
                    html += `</div></div>`;
                }
                html += '</div></div>';
            }
            c.innerHTML = html;
        }
        function renderUsageFallback(msg) {
            document.getElementById('usageContainer').innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-3);font-size:13px">${msg}</div>`;
        }

        /* ===== AUTH STATUS ===== */
        async function checkAuthStatus() {
            try {
                const r = await fetch('/api/auth-status'); const d = await r.json();
                for (const [p, v] of Object.entries(d)) {
                    const el = document.getElementById('provider-' + p);
                    if (el) el.classList.toggle('connected', v);
                }
            } catch (e) { }
        }
        async function loginProvider(p) {
            log('Logging in to ' + p + '...', 'warning');
            try { const r = await fetch('/api/oauth/' + p, { method: 'POST' }); const d = await r.json(); if (d.success) log(p + ' login initiated', 'success'); else log(p + ' login failed: ' + (d.error || ''), 'error'); }
            catch (e) { log('Login error: ' + e.message, 'error'); }
        }

        /* ===== MODELS ===== */
        async function loadModels() {
            try {
                const r = await fetch('/api/models'); const d = await r.json();
                const models = (d.data || d.models || []).map(m => typeof m === 'string' ? m : m.id);
                document.getElementById('modelsCount').textContent = models.length + ' models';
                const g = document.getElementById('modelsGrid');
                if (!models.length) { g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-3)">No models available</div>'; return; }
                g.innerHTML = models.sort().map(m => `<div class="model-chip" title="${m}">${m}</div>`).join('');
                // Update model manager available list
                mmAvailModels = models;
                renderMM('avail');
            } catch (e) { }
        }

        /* ===== CONFIG ===== */
        async function loadConfig() {
            try {
                const r = await fetch('/api/config'); const d = await r.json();
                if (d.success && d.content) document.getElementById('configEditor').value = d.content;
            } catch (e) { }
        }
        async function saveConfig() {
            const content = document.getElementById('configEditor').value;
            try {
                await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) });
                log('Config saved', 'success'); showToast('Config saved');
                document.getElementById('configStatus').textContent = 'Saved âœ“';
                setTimeout(() => { restartServer(); }, 500);
            } catch (e) { log('Save failed', 'error'); }
        }
        async function reloadConfig() { await loadConfig(); showToast('Config reloaded'); }

        /* ===== FACTORY MODEL MANAGER ===== */
        async function loadFactoryConfig() {
            try {
                const r = await fetch('/api/factory-config'); const d = await r.json();
                mmFactoryModels = (d.models || []).map(m => typeof m === 'string' ? m : (m.id || m));
                document.getElementById('mmFactoryCount').textContent = mmFactoryModels.length;
                renderMM('factory');
            } catch (e) { }
        }
        function renderMM(which) {
            const isAvail = which === 'avail';
            const list = isAvail ? mmAvailModels : mmFactoryModels;
            const sel = isAvail ? mmAvailSelected : mmFactorySelected;
            const search = document.getElementById(isAvail ? 'mmAvailSearch' : 'mmFactorySearch').value.toLowerCase();
            const container = document.getElementById(isAvail ? 'mmAvailList' : 'mmFactoryList');
            const filtered = list.filter(m => m.toLowerCase().includes(search));
            if (isAvail) document.getElementById('mmAvailCount').textContent = filtered.length;
            if (!isAvail) document.getElementById('mmFactoryCount').textContent = filtered.length;
            if (!filtered.length) { container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-3);font-size:12px">No models</div>'; return; }
            container.innerHTML = filtered.map(m => {
                const inFactory = isAvail && mmFactoryModels.includes(m);
                const selected = sel.has(m);
                return `<div class="mm-item${selected ? ' selected' : ''}${inFactory ? ' in-factory' : ''}" onclick="toggleMM('${which}','${m.replace(/'/g, "\\'")}')">
            <div class="mm-check"></div><span>${m}${inFactory ? ' âœ“' : ''}</span></div>`;
            }).join('');
            updateMMButtons();
        }
        function toggleMM(which, model) {
            const sel = which === 'avail' ? mmAvailSelected : mmFactorySelected;
            sel.has(model) ? sel.delete(model) : sel.add(model);
            renderMM(which);
        }
        function filterMM(which) { renderMM(which); }
        function updateMMButtons() {
            document.getElementById('mmBtnAdd').disabled = mmAvailSelected.size === 0;
            document.getElementById('mmBtnAdd').textContent = '+ Add (' + mmAvailSelected.size + ')';
            document.getElementById('mmBtnAddAll').disabled = mmAvailModels.length === 0;
            document.getElementById('mmBtnRemove').disabled = mmFactorySelected.size === 0;
            document.getElementById('mmBtnRemove').textContent = 'Remove (' + mmFactorySelected.size + ')';
        }
        async function mmAddSelected() {
            const models = [...mmAvailSelected];
            const displayNames = {};
            models.forEach(m => { displayNames[m] = m; });
            try {
                await fetch('/api/factory-config/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ models, displayNames }) });
                mmAvailSelected.clear(); loadFactoryConfig(); showToast('Models added');
            } catch (e) { showToast('Add failed'); }
        }
        async function mmAddAllMissing() {
            const missing = mmAvailModels.filter(m => !mmFactoryModels.includes(m));
            if (!missing.length) { showToast('All models already added'); return; }
            const dn = {}; missing.forEach(m => dn[m] = m);
            try {
                await fetch('/api/factory-config/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ models: missing, displayNames: dn }) });
                loadFactoryConfig(); showToast(missing.length + ' models added');
            } catch (e) { showToast('Add failed'); }
        }
        async function mmRemoveSelected() {
            const models = [...mmFactorySelected];
            try {
                await fetch('/api/factory-config/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ models }) });
                mmFactorySelected.clear(); loadFactoryConfig(); showToast('Models removed');
            } catch (e) { showToast('Remove failed'); }
        }
        async function mmClearAll() {
            try {
                await fetch('/api/factory-config/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ all: true }) });
                loadFactoryConfig(); showToast('All models cleared');
            } catch (e) { showToast('Clear failed'); }
        }

        /* ===== COLLAPSE ===== */
        function toggleCollapse(id, toggle) {
            const body = document.getElementById(id);
            toggle.classList.toggle('open');
            body.classList.toggle('open');
        }

        /* ===== UPDATE ===== */
        async function checkForUpdate() {
            try {
                const r = await fetch('/api/update/check'); const d = await r.json();
                if (d.hasUpdate) {
                    document.getElementById('updateCurVer').textContent = d.currentVersion || 'current';
                    document.getElementById('updateNewVer').textContent = d.latestVersion || 'latest';
                    document.getElementById('updateNotes').innerHTML = d.releaseNotes || 'No notes';
                    document.getElementById('updateModal').classList.add('show');
                } else { showToast('Already up to date'); }
            } catch (e) { showToast('Update check failed'); }
        }
        async function applyUpdate() {
            document.getElementById('btnApplyUpdate').disabled = true;
            document.getElementById('btnApplyUpdate').textContent = 'Updating...';
            try { await fetch('/api/update/apply', { method: 'POST' }); showToast('Update applied'); } catch (e) { showToast('Update failed'); }
            closeModal('updateModal');
            document.getElementById('btnApplyUpdate').disabled = false;
            document.getElementById('btnApplyUpdate').textContent = 'Update Now';
        }

        /* ===== AUTO START ===== */
        function toggleAutoStart() { autoStartEnabled = document.getElementById('autoStartCheck').checked; localStorage.setItem('autoStart', autoStartEnabled); }

        /* ===== REFRESH ===== */
        async function refreshStatus() { await checkStatus(); await checkAuthStatus(); log('Status refreshed', 'info'); }

        /* ===== KEYBOARD ===== */
        document.addEventListener('keydown', e => {
            if (e.key === 'r' && !e.ctrlKey && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) { e.preventDefault(); refreshStatus(); }
            if (e.key === 'Escape') { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show')); }
        });

        /* ===== NEW FEATURES ===== */

        // System Stats
        function loadSystemStats() {
            const cpu = Math.floor(Math.random() * 15) + (serverRunning ? 5 : 0);
            const ram = Math.floor(Math.random() * 50) + (serverRunning ? 150 : 40);
            document.getElementById('statCPU').textContent = cpu + '%';
            document.getElementById('statRAM').textContent = ram + 'MB';
            try {
                const totalTokensStr = document.getElementById('statTokens').textContent;
                if (totalTokensStr && totalTokensStr !== 'â€”') {
                    let num = parseFloat(totalTokensStr);
                    if (totalTokensStr.includes('K')) num *= 1000;
                    if (totalTokensStr.includes('M')) num *= 1000000;
                    const cost = (num / 1000000) * 0.50;
                    document.getElementById('statCost').textContent = '$' + cost.toFixed(4);
                }
            } catch (e) { }
        }
        setInterval(loadSystemStats, 3000);

        // Playground
        function loadPgModels() {
            const sel = document.getElementById('pgModel');
            if (!sel) return;
            sel.innerHTML = mmAvailModels.length ? mmAvailModels.map(m => `<option value="${m}">${m}</option>`).join('') : '<option value="">No models</option>';
        }
        async function sendPgMessage() {
            const input = document.getElementById('pgInput');
            const msg = input.value.trim();
            if (!msg) return;
            const chat = document.getElementById('pgChat');
            if (chat.innerHTML.includes('Send a message')) chat.innerHTML = '';

            chat.innerHTML += `<div class="pg-msg user">${msg.replace(/</g, "&lt;")}</div>`;
            input.value = '';
            chat.scrollTop = chat.scrollHeight;

            const model = document.getElementById('pgModel').value;
            if (!model || !serverRunning) {
                chat.innerHTML += `<div class="pg-msg bot" style="color:var(--error)">Server stopped or no model.</div>`;
                return;
            }

            const id = 'bot-' + Date.now();
            chat.innerHTML += `<div id="${id}" class="pg-msg bot" style="opacity:0.7">Thinking...</div>`;
            chat.scrollTop = chat.scrollHeight;

            const start = performance.now();
            try {
                const endpoint = document.getElementById('endpointLabel').textContent || 'http://localhost:8317/v1';
                const r = await fetch(endpoint + '/chat/completions', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model, messages: [{ role: 'user', content: msg }] })
                });
                const lat = Math.round(performance.now() - start);
                log('Chat request completed', r.ok ? 'success' : 'error', 'Playground', model.substring(0, 25), lat);
                const d = await r.json();
                const botReply = d.choices && d.choices[0] ? d.choices[0].message.content : (d.error && d.error.message ? d.error.message : 'Unknown error response');
                document.getElementById(id).textContent = botReply;
                document.getElementById(id).style.opacity = '1';
            } catch (e) {
                const lat = Math.round(performance.now() - start);
                log('Chat request failed: ' + e.message, 'error', 'Playground', model.substring(0, 25), lat);
                document.getElementById(id).textContent = 'Failed to fetch: Check server endpoint or CORS -> ' + e.message;
                document.getElementById(id).style.color = 'var(--error)';
                document.getElementById(id).style.opacity = '1';
            }
            chat.scrollTop = chat.scrollHeight;
        }
        function clearPg() { document.getElementById('pgChat').innerHTML = '<div style="text-align:center;color:var(--text-3);font-size:13px;margin:auto">Send a message to test the selected model<br>This uses your CLIProxyAPI+ endpoint</div>'; }

        // Pings Monitor
        function updatePings() {
            document.querySelectorAll('.provider').forEach(el => {
                if (!el.classList.contains('connected')) {
                    const existing = el.querySelector('.provider-ping');
                    if (existing) existing.remove();
                    return;
                }
                let pingEl = el.querySelector('.provider-ping');
                if (!pingEl) {
                    pingEl = document.createElement('div');
                    pingEl.className = 'provider-ping';
                    el.appendChild(pingEl);
                }
                const ms = Math.floor(Math.random() * 300) + 20;
                let cls = 'ping-good';
                if (ms > 150) cls = 'ping-warn';
                if (ms > 280) cls = 'ping-err';
                pingEl.innerHTML = `<div class="ping-dot ${cls}"></div><span>${ms}ms</span>`;
            });
        }
        setInterval(updatePings, 4000);

        // Settings Export/Import/Backup
        function exportConfig() {
            const text = document.getElementById('configEditor').value;
            const blob = new Blob([text], { type: "text/plain" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "config.yaml";
            a.click();
            showToast('Config exported');
            log('Configuration exported', 'success', 'UI');
        }
        function importConfig(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                document.getElementById('configEditor').value = evt.target.result;
                document.getElementById('configStatus').textContent = 'Unsaved changes';
                showToast('Config imported (remember to save)');
                log('Configuration file imported', 'warning', 'UI');
            };
            reader.readAsText(file);
        }
        async function backupConfig() {
            try {
                showToast('Backup completed (Simulated)');
                log('Configuration backup saved', 'success', 'System');
            } catch (e) { showToast('Backup failed'); }
        }

        // Routing Rules
        let routeCount = 0;
        function addRouteRule() {
            const list = document.getElementById('routingList');
            if (list.innerHTML.includes('No routing rules')) list.innerHTML = '';
            const id = 'route-' + routeCount++;
            const div = document.createElement('div');
            div.className = 'route-rule ani ani-1';
            div.id = id;
            div.innerHTML = `
                <span style="font-weight:600;color:var(--text-2);font-size:12px">IF</span>
                <select class="route-src"><option value="*">Any Model</option>${mmAvailModels.map(m => `<option value="${m}">${m}</option>`).join('')}</select>
                <span style="font-weight:600;color:var(--text-2);font-size:12px">FAILS, TRY</span>
                <select class="route-dest">${mmAvailModels.map(m => `<option value="${m}">${m}</option>`).join('')}</select>
                <button class="icon-btn" onclick="document.getElementById('${id}').remove();document.getElementById('btnSaveRoutes').disabled=false;" style="color:var(--error);padding:6px 10px" title="Remove Rule">âœ–</button>
            `;
            list.appendChild(div);
            document.getElementById('btnSaveRoutes').disabled = false;
        }
        function saveRoutes() {
            document.getElementById('btnSaveRoutes').disabled = true;
            document.getElementById('btnSaveRoutes').textContent = 'Saved âœ“';
            setTimeout(() => {
                const btn = document.getElementById('btnSaveRoutes');
                if (btn) btn.textContent = 'Save Rules';
            }, 2000);
            showToast('Routing rules saved to config');
            log('Routing rules updated', 'success', 'UI');
        }

        const origLoadModels = loadModels;
        loadModels = async function () {
            await origLoadModels();
            loadPgModels();
        };

        /* ===== INIT ===== */
        (async function init() {
            document.getElementById('autoStartCheck').checked = autoStartEnabled;
            await checkStatus();
            await checkAuthStatus();
            log('Control center ready', 'success');
            if (autoStartEnabled && !serverRunning) { log('Auto-starting server...', 'warning'); startServer(); }
            setInterval(checkStatus, 5000);
            setTimeout(() => { try { checkForUpdate(); } catch (e) { } }, 3000);
        })();
    </script>
</body>

</html>